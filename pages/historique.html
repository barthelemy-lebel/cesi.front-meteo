<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="/styles/style.css" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.3.0/font/bootstrap-icons.css"
    />
    <title>Formulaire et Affichage des Données</title>
  </head>
  <body>
    <nav>
      <div class="links">
        <a href="index.html">Accueil</a>
        <a href="/pages/historique">Historique</a>
      </div>
      <div class="actions">
        <i class="bi bi-gear-fill"></i>
      </div>
    </nav>

    <form id="sensorForm">
      <div class="params-form">
        <select id="sensor-id" name="sensor_id">
          <option value="619048">619048</option>
          <option value="6219043">6219043</option>
          <option value="6218223">6218223</option>
        </select>
      </div>

      <div class="params-form">
        <input
          type="datetime-local"
          id="start_date"
          name="start_date"
          required
        />
      </div>

      <div class="params-form">
        <input type="datetime-local" id="end_date" name="end_date" required />
      </div>

      <input type="submit" value="Valider" />

      <input type="submit" value="Recharger" />
    </form>

    <h2>Historique de Données</h2>

    <table id="sensorTable">
      <thead>
        <tr>
          <th>Nom</th>
          <th>Humidité</th>
          <th>Température</th>
          <th>Date</th>
        </tr>
      </thead>
      <tbody id="sensorTableBody">
        <!-- Les données seront ajoutées ici dynamiquement -->
      </tbody>
    </table>

    <script>
      function updateSensorTable(sensorData) {
        const sensorTableBody = document.getElementById("sensorTableBody");
        // Effacer le contenu actuel du tableau
        sensorTableBody.innerHTML = "";

        sensorData.forEach((sensor) => {
          const sensorTableRow = document.createElement("tr");
          sensorTableRow.innerHTML = `
            <td>${sensor.sensor_name}</td>
            <td>${sensor.humidity}</td>
            <td>${sensor.temperature}</td>
            <td>${sensor.date}</td>
          `;
          sensorTableBody.appendChild(sensorTableRow);
        });
      }

      function getSensorData(sensorId, startDate, endDate) {
        const formattedStartDate = new Date(startDate).toISOString();
        const formattedEndDate = new Date(endDate).toISOString();

        const serverUrl = `https://34bc-195-25-86-166.ngrok-free.app/?sensor_id=${encodeURIComponent(
          sensorId
        )}&start_date=${encodeURIComponent(
          formattedStartDate
        )}&end_date=${encodeURIComponent(formattedEndDate)}`;

        fetch(serverUrl)
          .then((response) => response.json())
          .then((data) => {
            updateSensorTable(data);
          })
          .catch((error) =>
            console.error("Erreur de récupération des données:", error)
          );
      }

      document
        .getElementById("sensorForm")
        .addEventListener("submit", function (event) {
          event.preventDefault();

          const selectedElement = document.getElementById("sensor-id").value;
          const startDate = document.getElementById("start_date").value;
          const endDate = document.getElementById("end_date").value;

          getSensorData(selectedElement, startDate, endDate);
        });
    </script>
  </body>
</html>
